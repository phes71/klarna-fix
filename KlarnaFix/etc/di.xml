<?xml version="1.0"?>
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">

    <!-- Klarna cookie + keys -->
    <type name="Klarna\Kp\Controller\Klarna\Cookie">
        <plugin name="gbs_klarna_cookie_guard"
                type="GerrardSBS\KlarnaFix\Plugin\CookieGuard"
                sortOrder="10"/>
        <plugin name="gbs_klarna_keys_after_cookie"
                type="GerrardSBS\KlarnaFix\Plugin\SessionKeysOnCookie"
                sortOrder="20"/>
    </type>

    <!-- Skip Klarna cookie step if possible -->
    <type name="Klarna\Kp\Model\ConfigProvider\UrlConfig">
        <plugin name="gbs_klarna_url_skip_cookie"
                type="GerrardSBS\KlarnaFix\Plugin\UrlConfigSkipCookie"
                sortOrder="10"/>
    </type>

    <!-- Guard managers (post-order chatter) -->
    <type name="Magento\Checkout\Model\GuestPaymentInformationManagement">
        <plugin name="gbs_klarna_api_guard_guest"
                type="GerrardSBS\KlarnaFix\Plugin\ApiGuard"
                sortOrder="10"/>
        <plugin name="gbs_klarna_getinfo_guard_guest"
                type="GerrardSBS\KlarnaFix\Plugin\GetPaymentInfoGuard"
                sortOrder="20"/>
    </type>
    <type name="Magento\Checkout\Model\PaymentInformationManagement">
        <plugin name="gbs_klarna_api_guard_cust"
                type="GerrardSBS\KlarnaFix\Plugin\ApiGuard"
                sortOrder="10"/>
        <plugin name="gbs_klarna_getinfo_guard"
                type="GerrardSBS\KlarnaFix\Plugin\GetPaymentInfoGuard"
                sortOrder="20"/>
    </type>

    <type name="Magento\Checkout\Model\PaymentDetailsManagement">
		<plugin name="gbs_klarna_getinfo_guard_details"
				type="GerrardSBS\KlarnaFix\Plugin\GetPaymentInfoGuard"
				sortOrder="1"/>
	</type>

    <!-- Klarna quoteStatus tightening -->
    <type name="Klarna\Kp\Controller\Klarna\QuoteStatus">
        <plugin name="gbs_klarna_keys_after_quote_status"
                type="GerrardSBS\KlarnaFix\Plugin\SessionKeysOnQuoteStatus"
                sortOrder="10"/>
        <plugin name="gbs_klarna_quote_status_fix"
                type="GerrardSBS\KlarnaFix\Plugin\QuoteStatusFix"
                sortOrder="5"/>
    </type>

    <!-- Success pipeline -->
    <type name="Magento\Checkout\Controller\Onepage\Success">
        <plugin name="gbs_klarna_success_access_guard"
                type="GerrardSBS\KlarnaFix\Plugin\SuccessAccessGuard"
                sortOrder="5"/>
        <plugin name="gbs_klarna_success_keys"
                type="GerrardSBS\KlarnaFix\Plugin\SuccessKeys"
                sortOrder="10"/>
        <plugin name="gbs_klarna_auto_login"
                type="GerrardSBS\KlarnaFix\Plugin\AutoLoginOnSuccess"
                sortOrder="12"/>
        <plugin name="gbs_klarna_success_guard"
                type="GerrardSBS\KlarnaFix\Plugin\SuccessGuard"
                sortOrder="15"/>
    </type>

    <!-- Cleanup after render -->
    <type name="Magento\Framework\View\Result\Page">
        <plugin name="gbs_klarna_success_cleanup_after_render"
                type="GerrardSBS\KlarnaFix\Plugin\SuccessCleanupAfterRender"
                sortOrder="10"/>
    </type>

    <!-- Patch success block when session expired -->
    <type name="Magento\Checkout\Block\Onepage\Success">
        <plugin name="gbs_klarna_success_view_patch"
                type="GerrardSBS\KlarnaFix\Plugin\SuccessViewPatch"
                sortOrder="1"/>
    </type>

    <!-- Reset flag at the start of a fresh checkout -->
    <type name="Magento\Checkout\Controller\Index\Index">
        <plugin name="gbs_klarna_clear_flag_checkout"
                type="GerrardSBS\KlarnaFix\Plugin\ClearSuccessFlag" sortOrder="10"/>
    </type>
    <type name="Magento\Checkout\Controller\Cart\Index">
        <plugin name="gbs_klarna_clear_flag_cart"
                type="GerrardSBS\KlarnaFix\Plugin\ClearSuccessFlag" sortOrder="10"/>
    </type>

    <!-- Persist the “create account” password hash onto the quote -->
    <type name="Magento\Checkout\Model\PaymentInformationManagement">
        <plugin name="gbs_persist_reg_intent"
                type="GerrardSBS\KlarnaFix\Plugin\PersistRegistrationIntent"
                sortOrder="5"/>
    </type>
    <type name="Magento\Checkout\Model\GuestPaymentInformationManagement">
        <plugin name="gbs_persist_reg_intent_guest"
                type="GerrardSBS\KlarnaFix\Plugin\PersistRegistrationIntent"
                sortOrder="5"/>
    </type>

    <!-- Seed Swissup’s observer from the order payment -->
    <type name="Swissup\CheckoutRegistration\Observer\CreateAccount">
        <plugin name="gbs_seed_registration_session_from_order"
                type="GerrardSBS\KlarnaFix\Plugin\CreateAccountSessionSeed"
                sortOrder="1"/>
    </type>
</config>
